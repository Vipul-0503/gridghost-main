rules_version='2'

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ğŸ” User profiles (role storage)
    match /users/{userId} {
      allow read: if request.auth != null
                  && request.auth.uid == userId;
      allow write: if false; // roles cannot be changed from client
    }

    // ğŸ”¥ Theft reports (IMMUTABLE AUDIT LOG)
    match /theft_reports/{reportId} {
      allow create: if request.auth != null;
      allow read: if isAdmin();
      allow update, delete: if false; // IMMUTABLE
    }

    // âš¡ Grid hotspots (restricted access)
    match /grid_hotspots/{hotspotId} {
      allow read: if isVerifiedLineman() || isAdmin();
      allow write: if false;
    }

    // ğŸ” Helper functions
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid))
        .data.role;
    }

    function isVerifiedLineman() {
      return getUserRole() == "verified_lineman";
    }

    function isAdmin() {
      return getUserRole() == "admin";
    }
  }
}

